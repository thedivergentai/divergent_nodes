# Divergent Nodes - Custom ComfyUI Nodes

This repository contains a collection of custom nodes for ComfyUI designed to integrate external AI models, provide utilities, and enable advanced workflows.

## Installation

1.  **Clone Repository:**
    Navigate to your `ComfyUI/custom_nodes/` directory and clone this repository:
    ```bash
    cd ComfyUI/custom_nodes/
    git clone https://github.com/thedivergentai/divergent_nodes.git divergent_nodes
    ```
    *(Note: If you cloned previously, you can update with `git pull` inside the `divergent_nodes` directory)*

2.  **Install Dependencies:**
    Install the required Python packages:
    ```bash
    cd divergent_nodes
    pip install -r requirements.txt
    ```

3.  **Set up API Key (for Gemini Node):**
    *   **Recommended:** Create or update `config.json` in the `divergent_nodes` directory (this directory) with your Google AI Studio API key:
        ```json
        {
          "GOOGLE_API_KEY": "YOUR_API_KEY_HERE"
        }
        ```
    *   **Alternatively (less preferred):** Create a file named `.env` in the `divergent_nodes` directory (this directory).
    *   Add your Google AI Studio API key to the `.env` file in the following format:
        ```
        GOOGLE_API_KEY=YOUR_API_KEY_HERE
        ```
    *   Refer to the `example_config.json` or `.env.example` file for guidance.
    *   The `config.json` and `.env` files are included in `.gitignore` and will not be tracked by Git.

4.  **Restart ComfyUI:**
    Ensure you fully restart the ComfyUI server after installation/updates.

The nodes should now appear in the ComfyUI node menu under their respective categories.

## Included Nodes

This pack currently includes the following nodes:

*   **CLIP Token Counter** (`Divergent AI 游놓/Text Utils`): Counts tokens for given text using a selected CLIP tokenizer.
*   **Divergent Gemini Node** (`Divergent AI 游놓/Gemini`): Generates text (optionally using image input) via the Google Gemini API. Requires API key. Supports extended thinking and thinking token budget.
*   **KoboldCpp API Connector (Basic)** (`Divergent AI 游놓/KoboldCpp`): Connects to an *already running* KoboldCpp instance for text generation.
*   **LoRA Strength XY Plot** (`Divergent AI 游놓/XY Plots`): Generates an image grid comparing different LoRAs (X-axis) against varying model strengths (Y-axis).
*   **MusiQ Image Scorer** (`Divergent AI 游놓/MusiQ`): Scores images based on aesthetic and technical quality using Google's MusiQ models.
*   **Save Image Enhanced (DN)** (`Divergent AI 游놓/Image`): Saves images with enhanced options including custom output folder, filename prefixing, and optional caption saving.

---

### MusiQ Image Scorer

Scores images based on aesthetic and technical quality using Google's MusiQ models. It allows you to select which type of scoring to perform (aesthetic, technical, or both) and which specific technical model to use.

**Inputs:**

*   `image` (IMAGE): The image to be scored.
*   `aesthetic_model` (COMBO): The aesthetic model to use (currently only `AVA`).
*   `technical_model` (COMBO): The technical model to use (`KonIQ-10k`, `SPAQ`, `PaQ-2-PiQ`).
*   `score_aesthetic` (BOOLEAN): Enable/disable aesthetic scoring.
*   `score_technical` (BOOLEAN): Enable/disable technical scoring.

**Outputs:**

*   `AESTHETIC_SCORE` (FLOAT): The aesthetic quality score (0.0 if disabled or error).
*   `TECHNICAL_SCORE` (FLOAT): The technical quality score (0.0 if disabled or error).
*   `ERROR_MESSAGE` (STRING): Any error or warning messages during scoring.

**Category:** `Divergent AI 游놓/MusiQ`

---

### CLIP Token Counter

Counts the number of tokens generated by a CLIP tokenizer for the input text. Useful for understanding prompt length limits.

**Inputs:**

*   `text` (STRING): The text string you want to analyze.
*   `tokenizer_name` (COMBO): The name of the Hugging Face CLIP tokenizer model to use (e.g., `openai/clip-vit-base-patch32`, `stabilityai/stable-diffusion-clip-vit-large-patch14`).

**Outputs:**

*   `token_count` (INT): The total number of tokens generated for the input text by the selected tokenizer (including special tokens).

**Category:** `Divergent AI 游놓/Text Utils`

---

### Divergent Gemini Node

Connects to the Google Gemini API to generate text based on a prompt and optional image input. Requires a `GOOGLE_API_KEY` (preferably in `config.json` or as an environment variable). It dynamically fetches the list of available models supporting content generation when ComfyUI loads the node.

**Inputs:**

*   `model` (COMBO): Select the Gemini model to use (list dynamically fetched if API key is valid).
*   `prompt` (STRING): The text prompt for generation.
*   `image_optional` (IMAGE): Optional image input for multimodal models (e.g., gemini-pro-vision, gemini-1.5-*).
*   `temperature` (FLOAT): Controls randomness. Higher values (e.g., 1.0) are more creative, lower values (e.g., 0.2) are more deterministic. (0.0-2.0)
*   `top_p` (FLOAT): Nucleus sampling probability threshold (e.g., 0.95). 1.0 disables. (0.0-1.0)
*   `top_k` (INT): Top-K sampling threshold (consider probability of token). (>= 1)
*   `max_output_tokens` (INT): Maximum number of tokens to generate in the response. (>= 1)
*   `safety_harassment` / `safety_hate_speech` / `safety_sexually_explicit` / `safety_dangerous_content` (COMBO): Safety thresholds for different safety categories.
*   `extended_thinking` (BOOLEAN, default: `True`): If `True`, the model may use extended thinking (internal reasoning) if supported. When `False`, thinking mode is explicitly disabled by sending `include_thoughts=False` to the API.
*   `thinking_token_budget` (INT, default: `-1`): Token budget for the model's thinking process.
    *   `-1`: Automatic (model determines budget). In this mode, the API manages the thought token allocation. The `max_output_tokens` parameter will be applied as a total limit for *both* the generated response and thoughts. It is possible for thoughts to consume a significant portion, or even all, of this budget, potentially resulting in a `MAX_TOKENS` error with no generated text if the response cannot fit.
    *   `0`: Disables thinking (equivalent to `extended_thinking: False`).
    *   `>0`: Sets a specific token budget for thoughts.
    *   **Important:** If `extended_thinking` is `True` and `thinking_token_budget` is `>0`, the node will automatically reduce the `max_output_tokens` provided to the API by this budget. This ensures the generated response adheres to the remaining token limit, effectively reserving tokens for thoughts. For example, if `max_output_tokens` is 2048 and `thinking_token_budget` is 500, the effective `max_output_tokens` for the *response* will be 1548.
*   `output_thoughts` (BOOLEAN, default: `False`): If `True`, the model's internal thought process will be included in the output text. Otherwise, thoughts are suppressed from the output.
*   `cached_context` (STRING, default: `""`): Optional: The text context to cache. If provided, this context will be cached and reused for subsequent requests. The cache name is automatically generated from a hash of the context.

**Outputs:**

*   `text` (STRING): The generated text response from the Gemini API, or an error/status message.

**Category:** `Divergent AI 游놓/Gemini`

---

### KoboldCpp API Connector (Basic)

Connects to an **already running** KoboldCpp instance via its API for text generation. Does **not** launch or manage the process.

**Prerequisites:**

*   KoboldCpp instance running and accessible at the specified `api_url`.
*   `requests` library installed (`pip install -r requirements.txt`).

**How it Works:**

1.  **Check Connection:** Verifies API reachability.
2.  **Prepare Payload:** Creates JSON with prompt, image (if provided, converted to Base64), and generation settings.
3.  **API Call:** Sends POST request to `/api/v1/generate`.
4.  **Response:** Parses response and returns text.

**Inputs:**

*   `api_url` (STRING): Base URL of the running KoboldCpp API (e.g., `http://localhost:5001`).
*   `prompt` (STRING): Text prompt.
*   `max_length` / `temperature` / `top_p` / `top_k` / `rep_pen`: Generation parameters.
*   `image_optional` (IMAGE): Optional image input (requires compatible model/mmproj loaded on the running instance).
*   `stop_sequence` (STRING): Optional comma/newline separated stop sequences.

**Outputs:**

*   `text` (STRING): Generated text or error message.

**Category:** `Divergent AI 游놓/KoboldCpp`

---

### LoRA Strength XY Plot

Generates an image grid comparing different LoRAs (X-axis) against varying model strengths (Y-axis).

**How it Works:**

1.  Loads a base checkpoint model.
2.  Scans the specified `lora_folder_path` for LoRA files.
3.  Determines which LoRAs and strength values to use based on `x_lora_steps` and `y_strength_steps`.
4.  Iterates through each combination:
    *   Applies the selected LoRA (or none for the baseline column) with the current strength to copies of the base model/CLIP.
    *   Generates an image using the provided prompt, latent, and sampling settings.
    *   Optionally saves the individual image.
5.  Assembles all generated images into a grid.
6.  Optionally draws labels (LoRA names, strengths) onto the grid.

**Inputs:**

*   `checkpoint_name` (COMBO): Base model checkpoint.
*   `lora_folder_path` (STRING): Path to folder containing LoRA files.
*   `positive` / `negative` (CONDITIONING): Text conditioning.
*   `latent_image` (LATENT): Initial latent image.
*   `seed` / `steps` / `cfg` / `sampler_name` / `scheduler`: Sampling parameters.
*   `x_lora_steps` (INT): Number of LoRAs for X-axis (0=all).
*   `y_strength_steps` (INT): Number of strength steps for Y-axis.
*   `max_strength` (FLOAT): Maximum LoRA strength for Y-axis.
*   `opt_clip` / `opt_vae` (CLIP/VAE): Optional CLIP/VAE overrides.
*   `save_individual_images` (BOOLEAN): Save each grid cell image.
*   `output_folder_name` (STRING): Subfolder name for saved images.
*   `row_gap` / `col_gap` (INT): Gaps in the final grid.
*   `draw_labels` (BOOLEAN): Draw labels on the grid.
*   `x_axis_label` / `y_axis_label` (STRING): Optional overall axis labels.

**Outputs:**

*   `xy_plot_image` (IMAGE): The final generated XY plot grid image.

**Category:** `Divergent AI 游놓/XY Plots`

---

### Save Image Enhanced (DN)

Saves the input images to a specified directory with optional caption and filename counter. Provides enhanced options compared to the standard Save Image node, including custom output folder and flexible filename prefixing.

**Inputs:**

*   `images` (IMAGE): The images to save.
*   `filename_prefix` (STRING, default: `"ComfyUI_DN_%date:yyyy-MM-dd%"`): The prefix for the file to save. This may include formatting information such as `%date:yyyy-MM-dd%` or `%Empty Latent Image.width%` to include values from nodes. Supports `%batch_num%`.
*   `output_folder` (STRING, default: `"output"`): The folder to save the images to. Can be relative to ComfyUI's output or an absolute path.
*   `add_counter_suffix` (BOOLEAN, default: `True`): If `True`, adds an incrementing numerical suffix (`_00001_`) to the filename to prevent overwriting.
*   `caption_file_extension` (STRING, default: `".txt"`): The extension for the caption file. (Optional)
*   `caption` (STRING): String to save as a caption file. (Optional, Force Input)

**Outputs:**

*   `last_filename_saved` (STRING): The full path of the last image file saved.

**Category:** `Divergent AI 游놓/Image`

---

## Example Workflows

Example workflows demonstrating node usage can be found in the [Divergent Nodes Wiki Examples section](divergent_nodes.wiki/Examples.md).

## Contributing

Contribution guidelines can be found in the [Divergent Nodes Wiki Contributing section](divergent_nodes.wiki/Contributing.md).

## License

License information for Divergent Nodes can be found in the project's GitHub repository.
